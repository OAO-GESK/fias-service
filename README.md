# Сервис получения сведений из адресного справочника ФИАС
- имя проекта: fias-service
- автор: max@huzm.ru
- дата: 2018

## Оглавление
- [Запрос **name_by_guid**](#name_by_guid)
- [Запрос **guids_by_name**](#guids_by_name)


## Общие сведения
Источником данных является БД "fias" формата PostgreSQL, где имена полей таблиц совпадают с именами параметров объектов выгрузки ФИАС XML-формата.
Имена таблиц:
- addrobj: адресные объекты
- house: дома
- stead: земельные участки
- room: помещения

Сервиc работает по принципу RPC (remote procedure call) посредством брокера очередей RabbitMQ.

## Требования
Python: 3.5+
- pika==0.11.2
- psycopg2==2.7.4

RabbitMQ: 3.5.7+

## Форматы запросов и ответов

Для всех запросов используется очередь ```fias-rpc```.

![the diagram](https://github.com/harinag/sass/blob/stable/Fias-Service.png)

<a name="name_by_guid" />

## name_by_guid

Запрос наименования адресного объекта по идентификатору AOGUID

Формат запроса:
```json
{ 
  "req" : "name_by_guid", 
  "arg" : { 
    "r"    : "<regioncode>",
    "guid" : "<aoguid>" 
  }
}
```
```r``` задает код региона, в котором сервис будет искать адресную запись. 
Для поиска по всей адресной базе ```r``` должен быть пустой строкой.

Формат ответа:
```json
{ 
  "result"    : "ok|notfound|error",
  "aoguid"     : "<aoguid>",
  "parentguid" : "<parentguid>",
  "formalname" : "<formalname>",
  "shortname"  : "<shortname>",
  "aolevel"    : "<aolevel>",
  "regioncode" : "<regioncode>"
}
```
```result``` принимает одно из значений:
- ```ok```: запрос завершился успешно, адресная запись найдена, информация в остальных полях ответа;
- ```notfound```: не найдено ни одной записи, соответствующей запросу;
- ```error```: запрос завершился с ошибкой - возможно неверно задан формат GUID (параметр ```guid``` запроса).

<a name="guids_by_name" />

## guids_by_name

Запрос поиска адресных объектов по соответствию имени (formalname) заданной строке.

Формат запроса:
```json
{
  "req" : "guids_by_name",
  "arg" : {
    "r"          : "<regioncode>",
    "aoname"     : "<имя объекта>",
    "parent"     : "<parentguid>",
    "aolevels"   : "<aolevel1>, <aolevel2>, ..."
  }
}
```
```parent``` здает *aoguid* родителя (*parentguid*) искомого объекта, если пустая строка то поиск по всей базе.
```aolevels``` задает список уровней *aolevel* искомого объекта (через запятую), если пустая строка то поиск по всей базе.
Уровни адресных объектов:
- 1: регион
- 3: район
- 35: городские и сельские поселения
- 4: город
- 6: населенный пункт
- 65: планировочная структура (СНТ, местности...)
- 7: улица (площ, пер, наб, ...)

Формат ответа:
```
{
  "result"  : "ok|notfound|error",
  "addrobj" : [
    { 
      "aoguid" : "<aoguid>", "parentguid" : "<parentguid>",
      "formalname" : "<formalname>", "shortname" : "<shortname>",
      "aolevel" : "<aolevel>", "regioncode" : "<regioncode>"
    },
    ...
  ]
}
```
```result``` принимает одно из значений:
- ```ok```: запрос завершился успешно, найдены одна или более записей;
- ```notfound```: не найдено ни одной записи, соответствующей запросу;
- ```error```: запрос завершился с ошибкой.

```addrobj``` - массив объектов, найденных по соответствию параметру запроса.
